<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Element Loading Test - Walkthrough Engine</title>
  <link rel="stylesheet" href="/css/walkthrough.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f3f4f6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    
    .dynamic-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      min-height: 200px;
    }
    
    button {
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    
    button:hover {
      background: #7c3aed;
    }
    
    button.secondary {
      background: #6b7280;
    }
    
    button.secondary:hover {
      background: #4b5563;
    }
    
    .status {
      margin-top: 20px;
      padding: 15px;
      background: #f3f4f6;
      border-radius: 6px;
      font-size: 14px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    
    .card {
      background: #f9fafb;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 10px;
      border: 2px solid #e5e7eb;
    }
    
    .card h3 {
      margin: 0 0 10px 0;
      color: #1f2937;
    }
    
    .card p {
      margin: 0;
      color: #6b7280;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .spinner {
      border: 3px solid #f3f4f6;
      border-top: 3px solid #8b5cf6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header" id="header">
      <h1>Dynamic Element Loading Test</h1>
      <p>Test walkthrough engine's ability to wait for dynamically loaded elements</p>
    </div>
    
    <div class="controls">
      <h3>Test Scenarios</h3>
      <button onclick="testImmediateElement()">Test 1: Immediate Element</button>
      <button onclick="testDelayedElement()">Test 2: Delayed Element (2s)</button>
      <button onclick="testVeryDelayedElement()">Test 3: Very Delayed Element (4s)</button>
      <button onclick="testMissingElement()">Test 4: Missing Element (timeout)</button>
      <button onclick="clearContent()" class="secondary">Clear Content</button>
      <button onclick="stopWalkthrough()" class="secondary">Stop Walkthrough</button>
      
      <div class="status" id="status">Status: Ready
Click a test button to start a walkthrough scenario</div>
    </div>
    
    <div class="dynamic-content" id="dynamic-content">
      <p style="color: #6b7280;">Dynamic content will appear here...</p>
    </div>
  </div>
  
  <script src="/js/demo/config.js"></script>
  <script src="/js/demo/orchestrator.js"></script>
  <script src="/js/demo/walkthrough-engine.js"></script>
  
  <script>
    // Initialize walkthrough engine
    const walkthroughEngine = new WalkthroughEngine(window.demoOrchestrator);
    
    // Register with orchestrator
    if (window.demoOrchestrator) {
      window.demoOrchestrator.registerComponent('walkthroughEngine', walkthroughEngine);
    }
    
    // Helper function to add dynamic content
    function addDynamicElement(id, title, description, delay = 0) {
      return new Promise((resolve) => {
        setTimeout(() => {
          const content = document.getElementById('dynamic-content');
          const card = document.createElement('div');
          card.className = 'card';
          card.id = id;
          card.innerHTML = `
            <h3>${title}</h3>
            <p>${description}</p>
          `;
          content.appendChild(card);
          updateStatus(`✓ Element added: ${id} (after ${delay}ms)`);
          resolve();
        }, delay);
      });
    }
    
    // Helper function to show loading state
    function showLoading(message) {
      const content = document.getElementById('dynamic-content');
      content.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>${message}</p>
        </div>
      `;
    }
    
    // Helper function to clear content
    function clearContent() {
      const content = document.getElementById('dynamic-content');
      content.innerHTML = '<p style="color: #6b7280;">Dynamic content will appear here...</p>';
      updateStatus('Content cleared');
    }
    
    // Test 1: Immediate element (already in DOM)
    async function testImmediateElement() {
      clearContent();
      updateStatus('Test 1: Starting walkthrough with immediate element...');
      
      // Add element immediately
      await addDynamicElement('immediate-card', 'Immediate Element', 'This element was added immediately', 0);
      
      const walkthrough = {
        id: 'test-immediate',
        title: 'Immediate Element Test',
        description: 'Tests walkthrough with element already in DOM',
        steps: [
          {
            id: 'step-1',
            title: 'Header',
            description: 'Starting with the header element',
            targetElement: '#header',
            position: 'bottom',
            highlightStyle: { animation: 'pulse' }
          },
          {
            id: 'step-2',
            title: 'Immediate Element',
            description: 'This element was already in the DOM when the step started. No waiting required!',
            targetElement: '#immediate-card',
            position: 'auto',
            waitForElement: true,
            highlightStyle: { animation: 'glow' }
          }
        ]
      };
      
      try {
        await walkthroughEngine.loadWalkthrough(walkthrough);
        await walkthroughEngine.start();
        updateStatus('Test 1: Walkthrough started successfully');
      } catch (error) {
        updateStatus('Test 1 Error: ' + error.message);
      }
    }
    
    // Test 2: Delayed element (2 seconds)
    async function testDelayedElement() {
      clearContent();
      updateStatus('Test 2: Starting walkthrough with delayed element (2s)...');
      
      const walkthrough = {
        id: 'test-delayed',
        title: 'Delayed Element Test',
        description: 'Tests walkthrough waiting for element to appear',
        steps: [
          {
            id: 'step-1',
            title: 'Header',
            description: 'Starting with the header element',
            targetElement: '#header',
            position: 'bottom',
            highlightStyle: { animation: 'pulse' }
          },
          {
            id: 'step-2',
            title: 'Loading...',
            description: 'The walkthrough is now waiting for a dynamic element to load. It will appear in 2 seconds...',
            targetElement: '#delayed-card',
            position: 'auto',
            waitForElement: true,
            highlightStyle: { animation: 'glow' },
            action: async () => {
              showLoading('Loading dynamic content... (2 seconds)');
              await addDynamicElement('delayed-card', 'Delayed Element', 'This element appeared after 2 seconds!', 2000);
            }
          }
        ]
      };
      
      try {
        await walkthroughEngine.loadWalkthrough(walkthrough);
        await walkthroughEngine.start();
        updateStatus('Test 2: Walkthrough started, waiting for element...');
      } catch (error) {
        updateStatus('Test 2 Error: ' + error.message);
      }
    }
    
    // Test 3: Very delayed element (4 seconds)
    async function testVeryDelayedElement() {
      clearContent();
      updateStatus('Test 3: Starting walkthrough with very delayed element (4s)...');
      
      const walkthrough = {
        id: 'test-very-delayed',
        title: 'Very Delayed Element Test',
        description: 'Tests walkthrough waiting longer for element',
        steps: [
          {
            id: 'step-1',
            title: 'Header',
            description: 'Starting with the header element',
            targetElement: '#header',
            position: 'bottom',
            highlightStyle: { animation: 'pulse' }
          },
          {
            id: 'step-2',
            title: 'Loading...',
            description: 'The walkthrough is waiting for a dynamic element. This one takes 4 seconds to load. Notice how the walkthrough patiently waits...',
            targetElement: '#very-delayed-card',
            position: 'auto',
            waitForElement: true,
            highlightStyle: { animation: 'glow' },
            action: async () => {
              showLoading('Loading dynamic content... (4 seconds)');
              await addDynamicElement('very-delayed-card', 'Very Delayed Element', 'This element appeared after 4 seconds!', 4000);
            }
          }
        ]
      };
      
      try {
        await walkthroughEngine.loadWalkthrough(walkthrough);
        await walkthroughEngine.start();
        updateStatus('Test 3: Walkthrough started, waiting for element...');
      } catch (error) {
        updateStatus('Test 3 Error: ' + error.message);
      }
    }
    
    // Test 4: Missing element (timeout after 5 seconds)
    async function testMissingElement() {
      clearContent();
      updateStatus('Test 4: Starting walkthrough with missing element (will timeout)...');
      
      const walkthrough = {
        id: 'test-missing',
        title: 'Missing Element Test',
        description: 'Tests walkthrough timeout when element never appears',
        steps: [
          {
            id: 'step-1',
            title: 'Header',
            description: 'Starting with the header element',
            targetElement: '#header',
            position: 'bottom',
            highlightStyle: { animation: 'pulse' }
          },
          {
            id: 'step-2',
            title: 'Waiting for Element...',
            description: 'The walkthrough is waiting for an element that will never appear. After 5 seconds, it will timeout and show this tooltip without highlighting.',
            targetElement: '#missing-card',
            position: 'center',
            waitForElement: true,
            highlightStyle: { animation: 'glow' },
            action: async () => {
              showLoading('Waiting for element that will never appear... (5s timeout)');
              // Don't add the element - let it timeout
            }
          },
          {
            id: 'step-3',
            title: 'Graceful Handling',
            description: 'Even though the previous element was missing, the walkthrough continued gracefully. This demonstrates robust error handling!',
            targetElement: '#dynamic-content',
            position: 'top',
            highlightStyle: { animation: 'pulse' }
          }
        ]
      };
      
      try {
        await walkthroughEngine.loadWalkthrough(walkthrough);
        await walkthroughEngine.start();
        updateStatus('Test 4: Walkthrough started, waiting for element (will timeout)...');
      } catch (error) {
        updateStatus('Test 4 Error: ' + error.message);
      }
    }
    
    function stopWalkthrough() {
      walkthroughEngine.stop();
      updateStatus('Walkthrough stopped');
    }
    
    function updateStatus(message) {
      const statusEl = document.getElementById('status');
      const timestamp = new Date().toLocaleTimeString();
      const currentStatus = statusEl.textContent;
      statusEl.textContent = `[${timestamp}] ${message}\n${currentStatus}`;
      console.log('[Test]', message);
    }
    
    // Listen to orchestrator events
    if (window.demoOrchestrator) {
      window.demoOrchestrator.on('walkthrough-started', (data) => {
        updateStatus('✓ Walkthrough started: ' + data.walkthroughId);
      });
      
      window.demoOrchestrator.on('walkthrough-stopped', (data) => {
        updateStatus('✓ Walkthrough stopped: ' + data.walkthroughId);
      });
      
      window.demoOrchestrator.on('walkthrough-completed', (data) => {
        updateStatus('✓ Walkthrough completed: ' + data.walkthroughId);
      });
    }
    
    console.log('[Test] Dynamic element loading test initialized');
    console.log('[Test] Click a test button to start a scenario');
  </script>
</body>
</html>
