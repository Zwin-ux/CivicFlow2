<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Mode ¬∑ CivicFlow2</title>
  <link rel="stylesheet" href="/css/app/base.css">
  <link rel="stylesheet" href="/css/layout.css">
  <link rel="stylesheet" href="/css/app/navigation.css">
  <link rel="stylesheet" href="/css/app/demo.css">
  <link rel="stylesheet" href="/css/professional-theme.css">
  <link rel="stylesheet" href="/css/components/toast-notification.css">
  <link rel="stylesheet" href="/css/components/role-switcher.css">
  <link rel="stylesheet" href="/css/components/role-views.css">
</head>
<body class="app-shell" style="background: linear-gradient(135deg, #5865ff 0%, #764ba2 100%);">
  <header class="app-top-bar">
    <a class="logo" href="/">
      <img src="/images/logo.svg" alt="CivicFlow2" class="logo-image" width="40" height="40">
      <div>
        <strong class="logo-name">CivicFlow2</strong>
        <small class="logo-tagline">Demo Mode Showcase</small>
      </div>
    </a>
    <nav>
      <a href="/investor-dashboard.html">Dashboard</a>
      <a href="/applications-list.html">Applications</a>
      <a href="/demo-landing.html" class="active">Demo Mode</a>
    </nav>
    <div class="top-actions">
      <button type="button" data-command-trigger aria-label="Open command palette">‚åòK</button>
      <button type="button" data-theme-toggle aria-label="Toggle theme">Toggle Theme</button>
      <span data-ws-status>Connecting...</span>
    </div>
  </header>

  <main class="app-layout">
    <section class="section-card hero-layout">
      <div class="hero-layout">
        <div class="title">Welcome to Demo Mode</div>
        <p class="subtitle">
          Experience CivicFlow2 with curated personas, AI guidance, and optimistic updates that feel like a polished app.
        </p>
        <div class="hero-points">
          <div class="hero-point">
            <strong>Relationship workbench</strong>
            <p>Blend borrower context, documents, and real-time status in one view.</p>
          </div>
          <div class="hero-point">
            <strong>Pipeline intelligence</strong>
            <p>Live SLA dashboards, proactive nudges, and audit-ready timelines.</p>
          </div>
          <div class="hero-point">
            <strong>AI Copilot</strong>
            <p>Document validation, missing item detection, and clear next steps.</p>
          </div>
          <div class="hero-point">
            <strong>Omnichannel follow-ups</strong>
            <p>Send SMS, email, or Teams reminders with one click.</p>
          </div>
        </div>
      </div>
    </section>

    <section class="section-card">
      <h2 class="section-title">Select Your Role</h2>
      <div class="roles" id="role-buttons">
        <button class="role-button" data-role="APPLICANT">
          <span class="role-label">Applicant Portal</span>
          <small>Guided checklists + instant AI feedback</small>
        </button>
        <button class="role-button" data-role="REVIEWER">
          <span class="role-label">Staff Workspace</span>
          <small>Pipeline + borrower timeline for call prep</small>
        </button>
        <button class="role-button" data-role="APPROVER">
          <span class="role-label">Approver Dashboard</span>
          <small>Decision-ready narratives and alerts</small>
        </button>
        <button class="role-button" data-role="ADMIN">
          <span class="role-label">Program Command</span>
          <small>Live SLA, intake mix, and audit health</small>
        </button>
      </div>
      <div class="role-preview" id="role-preview">
        <p class="preview-eyebrow">Role Spotlight</p>
        <h3 id="preview-title">Select a role to see the CRM storyline</h3>
        <p id="preview-description">Modernize lending operations with a guided workspace for every persona.</p>
        <div class="preview-metrics">
          <div>
            <span class="preview-headline" id="preview-headline">Pipeline + AI coaching in one tab</span>
            <span class="preview-stat" id="preview-heroStat">Live SLA visibility</span>
          </div>
          <ul id="preview-highlights">
            <li>AI document guardrails + CRM context</li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <nav class="mobile-bottom-nav" data-mobile-nav>
    <button type="button" data-target="/investor-dashboard.html">
      <span>üè†</span>
      <small>Home</small>
    </button>
    <button type="button" data-target="/applications-list.html">
      <span>üìã</span>
      <small>Apps</small>
    </button>
    <button type="button" data-target="/demo-landing.html">
      <span>üéØ</span>
      <small>Demo</small>
    </button>
    <button type="button" data-target="/demo-settings.html">
      <span>‚öôÔ∏è</span>
      <small>Settings</small>
    </button>
  </nav>

  <div class="command-palette" data-command-palette>
    <div class="command-card">
      <p class="text-muted">Command palette</p>
      <input type="search" placeholder="Search pages..." aria-label="Command palette search">
      <ul data-command-list></ul>
    </div>
  </div>

  <div id="toast-container" class="toast-root"></div>

  <script src="/js/state/app-state.js"></script>
  <script src="/js/theme/theme-manager.js"></script>
  <script src="/js/realtime/websocket-manager.js"></script>
  <script src="/js/cache/cache-manager.js"></script>
  <script src="/js/navigation/layout.js"></script>
  <script src="/js/demo/orchestrator.js"></script>
  <script src="/js/demo/role-switcher.js" defer></script>
  <script src="/js/demo/role-views.js" defer></script>
  <script src="/js/demo/role-switcher-init.js" defer></script>
  <script>
    const roleCatalog = {};
    let activeRole = null;
    const fallbackDestinations = {
      APPLICANT: '/demo-sba.html',
      REVIEWER: '/demo-sba.html',
      APPROVER: '/demo-sba.html',
      ADMIN: '/demo-sba.html',
    };

    const toastPalette = {
      info: '#3b82f6',
      success: '#10b981',
      warning: '#f59e0b',
      error: '#ef4444'
    };

    const toastIcons = {
      info: 'I',
      success: 'OK',
      warning: '!',
      error: 'X'
    };

    function showToast(message, type = 'info') {
      if (window.showToastNotification) {
        window.showToastNotification({
          title: type.charAt(0).toUpperCase() + type.slice(1),
          message,
          color: toastPalette[type] || '#3b82f6',
          icon: toastIcons[type] || '‚ÑπÔ∏è',
          priority: type === 'error' ? 'high' : 'normal',
          duration: 4200,
          type: 'custom'
        });
        return;
      }

      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function renderRolePreview(roleKey) {
      const role = roleCatalog[roleKey];
      if (!role) return;
      activeRole = roleKey;
      document.querySelectorAll('.role-button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.role === roleKey);
      });
      document.getElementById('preview-title').textContent = role.title;
      document.getElementById('preview-description').textContent = role.description;
      document.getElementById('preview-headline').textContent = role.headline;
      document.getElementById('preview-heroStat').textContent = role.heroStat;
      const highlights = document.getElementById('preview-highlights');
      highlights.innerHTML = role.highlights.map(item => `<li>${item}</li>`).join('');
    }

    async function loadRoleCatalog() {
      try {
        const response = await fetch('/api/v1/sba-demo/roles');
        if (!response.ok) return;
        const data = await response.json();
        data.roles.forEach(role => {
          roleCatalog[role.role] = role;
        });
        renderRolePreview('REVIEWER');
      } catch (error) {
        console.warn('Failed to load role showcase', error);
      }
    }

    async function startDemo(event, role) {
      const button = event.currentTarget || event.target;
      const originalLabel = button.innerHTML;
      button.dataset.originalLabel = originalLabel;
      button.disabled = true;
      button.classList.add('loading');
      button.innerHTML = '<span>Starting‚Ä¶</span>';

      try {
        const response = await fetch('/api/v1/demo/start', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userRole: role }),
        });

        if (!response.ok) {
          throw new Error('Failed to start demo session');
        }

        const data = await response.json();
        sessionStorage.setItem('demo_session', data.sessionId);
        sessionStorage.setItem('demo_role', data.userRole);
        sessionStorage.setItem('demo_expires', data.expiresAt);

        showToast('Demo session started successfully!', 'success');

        setTimeout(() => {
          const roleDetails = roleCatalog[role] || {};
          const destination = roleDetails.entryPoint || fallbackDestinations[role] || '/demo-sba.html';
          const targetUrl = new URL(destination, window.location.origin);
          targetUrl.searchParams.set('role', role);
          targetUrl.searchParams.set('demoSession', data.sessionId);
          window.location.href = `${targetUrl.pathname}${targetUrl.search}`;
        }, 400);
      } catch (error) {
        console.error('Error starting demo', error);
        showToast('Failed to start demo session. Please try again.', 'error');
        button.disabled = false;
        button.classList.remove('loading');
        button.innerHTML = button.dataset.originalLabel || originalLabel;
      }
    }

    if (sessionStorage.getItem('demo_session')) {
      const role = sessionStorage.getItem('demo_role');
      showToast('You already have an active demo session', 'info');

      setTimeout(() => {
        const roleDetails = roleCatalog[role] || {};
        const destination = roleDetails.entryPoint || fallbackDestinations[role] || '/demo-sba.html';
        const targetUrl = new URL(destination, window.location.origin);
        targetUrl.searchParams.set('role', role || 'REVIEWER');
        targetUrl.searchParams.set('demoSession', sessionStorage.getItem('demo_session'));
        window.location.href = `${targetUrl.pathname}${targetUrl.search}`;
      }, 1500);
    }

    document.querySelectorAll('.role-button').forEach(btn => {
      const roleKey = btn.dataset.role;
      btn.addEventListener('click', (event) => startDemo(event, roleKey));
      btn.addEventListener('mouseenter', () => renderRolePreview(roleKey));
      btn.addEventListener('focus', () => renderRolePreview(roleKey));
    });

    loadRoleCatalog();
  </script>
  <script src="/js/navigation/app-shell-init.js"></script>
</body>
</html>
