<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OctoDoc — SBA Documentation Drop-off (Demo)</title>
  <link rel="stylesheet" href="/css/sba-demo.css">
</head>
<body>
  <main class="container">
    <header class="hero" role="banner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <!-- Simple inline OctoDoc mark (SVG) -->
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <rect width="24" height="24" rx="6" fill="url(#g)"/>
            <defs>
              <linearGradient id="g" x1="0" x2="1">
                <stop offset="0" stop-color="#06b6d4"/>
                <stop offset="1" stop-color="#7c3aed"/>
              </linearGradient>
            </defs>
            <path d="M7 12c1.5-2 5-2 6 0" stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="9" cy="10" r="0.9" fill="#fff"/>
            <circle cx="15" cy="10" r="0.9" fill="#fff"/>
          </svg>
        </div>
        <div>
          <h1 id="page-title">OctoDoc</h1>
          <p class="tag">SBA Documentation Drop-off — Interactive Demo</p>
        </div>
      </div>
      <p class="lead">Select your loan type, upload documents, and let OctoDoc help you identify missing items and next steps. Demo data is ephemeral.</p>
    </header>

    <section class="panel left" aria-labelledby="page-title">
      <label for="loanType">Loan type</label>
      <select id="loanType">
        <option value="504">SBA 504</option>
        <option value="5a">SBA 5(a)</option>
      </select>

      <label for="applicantName">Applicant name (optional)</label>
      <input id="applicantName" type="text" placeholder="Jane Doe" aria-label="Applicant name" />

      <label for="email">Email (optional)</label>
      <input id="email" type="email" placeholder="jane@example.com" aria-label="Email" />

      <button id="startBtn" class="primary" aria-controls="checklist" aria-describedby="start-help">Start OctoDoc Demo</button>
      <div id="start-help" class="visually-hidden">Starts a temporary OctoDoc demo session. Data will be cleared after 30 minutes.</div>

      <div id="checklist" class="checklist" aria-live="polite"></div>
    </section>

    <section class="panel middle">
      <div id="uploader" class="uploader">
        <input id="fileInput" type="file" multiple aria-label="Upload documents" />
        <div class="dropzone" id="dropzone" role="button" tabindex="0" aria-label="Upload files dropzone">Drag & drop files here or click to browse</div>
      </div>

      <div id="uploads" class="uploads"></div>
    </section>

    <aside class="panel right">
      <h2>Agent Suggestions</h2>
  <div id="suggestions" aria-live="polite">No suggestions yet. Upload documents to get suggestions from OctoDoc.</div>

      <div class="actions">
        <button id="scheduleBtn" disabled class="secondary" aria-disabled="true">Request Pickup</button>
      </div>
    </aside>
  </main>

<script>
const apiBase = '/api/v1/sba-demo';
let session = null;
let polling = {};

function el(id){return document.getElementById(id)}

function renderChecklist(checklist){
  const container = el('checklist');
  container.innerHTML = '';
  checklist.forEach(item => {
    const div = document.createElement('div');
    div.className = 'check-item';
    div.innerHTML = `<input type="checkbox" data-id="${item.id}" ${item.required? 'checked':''} disabled> <strong>${item.title}</strong> ${item.required?'<em>(required)</em>':''}`;
    container.appendChild(div);
  });
}

async function startDemo(){
  const loanType = el('loanType').value;
  const applicantName = el('applicantName').value;
  const email = el('email').value;
  el('startBtn').disabled = true;
  el('startBtn').textContent = 'Starting...';
  const res = await fetch(apiBase + '/start', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({loanType, applicantName, email})});
  if (!res.ok) { alert('Failed to start demo'); return; }
  session = await res.json();
  el('scheduleBtn').disabled = false;
  el('scheduleBtn').setAttribute('aria-disabled','false');
  el('suggestions').innerText = 'Upload your documents to get suggestions.';
  fetchDocs();
  el('startBtn').textContent = 'Start OctoDoc Demo';
  el('startBtn').disabled = false;
}

async function fetchDocs(){
  if (!session) return;
  const res = await fetch(apiBase + '/documents/' + session.sessionId);
  if (!res.ok) return;
  const data = await res.json();
  renderChecklist(data.requiredChecklist || []);
  renderUploads(data.documents || []);
}

function renderUploads(docs){
  const container = el('uploads');
  container.innerHTML = '';
  docs.forEach(d=>{
    const div = document.createElement('div');
    div.className = 'upload-item';
    div.innerHTML = `<div><strong>${d.originalName}</strong> <small>${(d.size/1024).toFixed(1)} KB</small></div>
      <div>Status: <span class="status">${d.status}</span></div>
      <div class="validation">${d.validation? (d.validation.accepted? 'Accepted':'Needs attention') : 'Processing...'}</div>`;
    container.appendChild(div);
    // start polling jobs if processing
  });
}

async function handleFiles(files){
  if (!session) { alert('Start a demo session first'); return; }
  for (const file of files){
    const form = new FormData();
    form.append('sessionId', session.sessionId);
    form.append('file', file, file.name);
    const res = await fetch(apiBase + '/upload', { method: 'POST', body: form });
    if (!res.ok) { alert('Upload failed'); continue; }
    const data = await res.json();
    pollJob(data.jobId);
    fetchDocs();
  }
}

function pollJob(jobId){
  if (polling[jobId]) return;
  polling[jobId] = setInterval(async ()=>{
    const res = await fetch(apiBase + '/status/' + jobId);
    if (!res.ok){ clearInterval(polling[jobId]); delete polling[jobId]; return; }
    const data = await res.json();
    if (data.status === 'done' || data.status === 'failed'){
      clearInterval(polling[jobId]); delete polling[jobId];
      fetchDocs();
      // Announce completion and update suggestions
      updateSuggestions();
      const msg = document.createElement('div');
      msg.className = 'visually-hidden';
      msg.setAttribute('role','status');
      msg.textContent = `Document processing ${data.status}`;
      document.body.appendChild(msg);
      setTimeout(()=> msg.remove(),2000);
    }
  }, 800);
}

async function updateSuggestions(){
  // Simple client-side heuristics: if any doc needs_attention, show suggestion
  if (!session) return;
  const res = await fetch(apiBase + '/documents/' + session.sessionId);
  if (!res.ok) return;
  const data = await res.json();
  const needs = data.documents.filter(d=>d.status === 'needs_attention');
  const suggestions = el('suggestions');
  if (needs.length === 0){ suggestions.innerHTML = '<div class="ok">All documents look good so far.</div>'; return; }
  suggestions.innerHTML = '';
  needs.forEach(d=>{
    const div = document.createElement('div');
    div.className = 'suggestion';
    div.innerHTML = `<strong>${d.originalName}</strong>: ${d.validation?.reasons.join(', ')} <button data-doc="${d.documentId}" class="revalidate">Re-run validation</button>`;
    suggestions.appendChild(div);
  });
}

// Event wiring
el('startBtn').addEventListener('click', startDemo);
el('fileInput').addEventListener('change', (e)=> handleFiles(e.target.files));
const dropzone = el('dropzone');
dropzone.addEventListener('click', ()=> el('fileInput').click());
dropzone.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); el('fileInput').click(); } });
dropzone.addEventListener('dragover', (e)=>{ e.preventDefault(); dropzone.classList.add('drag'); });
dropzone.addEventListener('dragleave', (e)=>{ dropzone.classList.remove('drag'); });
dropzone.addEventListener('drop', (e)=>{ e.preventDefault(); dropzone.classList.remove('drag'); handleFiles(e.dataTransfer.files); });

el('scheduleBtn').addEventListener('click', async ()=>{
  if (!session) return;
  const res = await fetch(apiBase + '/schedule-pickup', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ sessionId: session.sessionId }) });
  if (!res.ok) { alert('Failed to schedule'); return; }
  const data = await res.json();
  alert('Pickup scheduled: ' + new Date(data.scheduledAt).toLocaleString());
});

// Delegated listener for revalidate
el('suggestions').addEventListener('click', async (e)=>{
  if (e.target && e.target.matches('.revalidate')){
    const docId = e.target.dataset.doc;
    const res = await fetch(apiBase + '/validate/' + docId, { method: 'POST' });
    if (res.ok){ const data = await res.json(); pollJob(data.jobId); }
  }
});

// keyboard shortcut: Enter on start button
el('startBtn').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') startDemo(); });
</script>
</body>
</html>
