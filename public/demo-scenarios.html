<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Scenarios</title>
  <link rel="stylesheet" href="/css/professional-theme.css">
  <link rel="stylesheet" href="/css/scenario-player.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="/" class="logo">
        <span class="logo-name">OctoDoc</span>
      </a>
      <ul class="nav-links">
        <li><a href="/demo-landing.html">Demo Home</a></li>
        <li><a href="/demo-scenarios.html" class="active">Scenarios</a></li>
      </ul>
    </div>
  </nav>
  <main class="scenario-page">
    <div class="scenario-shell">
      <header class="scenario-header">
        <div>
          <h1>Scenario Player</h1>
          <p class="scenario-description" id="scenario-description">
            Load a narrated scenario to track major workload shifts, document issues, and AI-powered decisions.
          </p>
        </div>
        <div>
          <label for="scenario-select">Choose scenario</label>
          <select id="scenario-select"></select>
        </div>
      </header>

      <section class="scenario-controls">
        <div class="scenario-actions">
          <button class="play" data-action="play">Play</button>
          <button class="pause" data-action="pause">Pause</button>
          <button class="stop" data-action="stop">Stop</button>
        </div>
        <div class="speed-controls">
          <span>Speed</span>
          <button data-speed="0.5">0.5×</button>
          <button data-speed="1" class="active">1×</button>
          <button data-speed="1.5">1.5×</button>
          <button data-speed="2">2×</button>
        </div>
        <div class="progress-bar">
          <span id="scenario-progress"></span>
        </div>
      </section>

      <section class="timeline-panel">
        <h2>Timeline</h2>
        <div id="timeline-events" class="timeline-list"></div>
      </section>

      <section class="narration-panel">
        <h3>Narration</h3>
        <p id="scenario-narration" class="narration-text">Select a scenario to begin.</p>
      </section>
    </div>
  </main>

  <script src="/js/demo/orchestrator.js"></script>
  <script src="/js/demo/scenario-player.js"></script>
  <script>
    const scenarioCatalog = [
      { id: 'rush-application', label: 'Rush Application', file: '/data/scenarios/rush-application.json' },
      { id: 'complex-review', label: 'Complex Review', file: '/data/scenarios/complex-review.json' },
      { id: 'document-issues', label: 'Document Issues', file: '/data/scenarios/document-issues.json' },
      { id: 'ai-assisted-decision', label: 'AI-Assisted Decision', file: '/data/scenarios/ai-assisted-decision.json' },
      { id: 'rejection-appeal', label: 'Rejection & Appeal', file: '/data/scenarios/rejection-appeal.json' }
    ];

    const player = new ScenarioPlayer();
    const scenarioSelect = document.getElementById('scenario-select');
    const timelineEl = document.getElementById('timeline-events');
    const progressBar = document.getElementById('scenario-progress');
    const narrationEl = document.getElementById('scenario-narration');
    const descriptionEl = document.getElementById('scenario-description');

    function populateScenarios() {
      scenarioCatalog.forEach((scenario) => {
        const option = document.createElement('option');
        option.value = scenario.id;
        option.textContent = scenario.label;
        scenarioSelect.appendChild(option);
      });
    }

    async function loadScenario(id) {
      const scenario = scenarioCatalog.find((item) => item.id === id);
      if (!scenario) {
        return;
      }
      const response = await fetch(scenario.file);
      if (!response.ok) {
        console.error('Failed to load scenario', id);
        return;
      }
      const definition = await response.json();
      descriptionEl.textContent = definition.description || '';
      timelineEl.innerHTML = '';
      player.loadScenario(definition);
      if (definition.events.length) {
        definition.events.forEach((event) => appendTimelineItem(event));
      }
      updateNarration(definition.narration?.[0]?.text || 'Ready to play.');
    }

    function appendTimelineItem(event) {
      const item = document.createElement('div');
      item.className = 'timeline-item';
      item.innerHTML = `
        <div>
          <strong>${event.title}</strong>
          <p>${event.details}</p>
        </div>
        <span>${(event.timestamp / 1000).toFixed(1)}s</span>
      `;
      timelineEl.appendChild(item);
      if (timelineEl.children.length > 8) {
        timelineEl.removeChild(timelineEl.firstChild);
      }
    }

    function updateNarration(text) {
      narrationEl.textContent = text;
    }

    function bindControls() {
      document.querySelectorAll('[data-action]').forEach((button) => {
        button.addEventListener('click', () => {
          const action = button.dataset.action;
          if (action === 'play') {
            player.play();
          } else if (action === 'pause') {
            player.pause();
          } else if (action === 'stop') {
            player.stop();
          }
        });
      });

      document.querySelectorAll('.speed-controls button').forEach((button) => {
        button.addEventListener('click', () => {
          const speed = Number(button.dataset.speed);
          player.setSpeed(speed);
          document.querySelectorAll('.speed-controls button').forEach((btn) => btn.classList.remove('active'));
          button.classList.add('active');
        });
      });

      scenarioSelect.addEventListener('change', (event) => {
        loadScenario(event.target.value);
      });
    }

    function startProgressLoop() {
      const update = () => {
        const percent = player.getProgress() * 100;
        progressBar.style.width = `${percent}%`;
        requestAnimationFrame(update);
      };
      requestAnimationFrame(update);
    }

    player.on('event', (event) => {
      appendTimelineItem(event);
      updateNarration(event.details);
    });

    player.on('seek', () => {
      updateNarration('Seeked to new point in the scenario.');
    });

    player.on('complete', () => {
      updateNarration('Scenario complete. Replay or choose another scenario.');
    });

    document.addEventListener('DOMContentLoaded', () => {
      populateScenarios();
      bindControls();
      startProgressLoop();
      loadScenario(scenarioCatalog[0].id);
    });
  </script>
</body>
</html>
