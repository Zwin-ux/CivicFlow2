<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo Scenarios</title>
  <link rel="stylesheet" href="/css/professional-theme.css">
  <link rel="stylesheet" href="/css/scenario-player.css">
</head>
<body>
  <nav class="navbar">
    <div class="container">
      <a href="/" class="logo">
        <span class="logo-name">OctoDoc</span>
      </a>
      <ul class="nav-links">
        <li><a href="/demo-landing.html">Demo Home</a></li>
        <li><a href="/demo-scenarios.html" class="active">Scenarios</a></li>
      </ul>
    </div>
  </nav>
  <main class="scenario-page">
    <div class="scenario-shell">
      <header class="scenario-header">
        <div>
          <h1>Scenario Player</h1>
          <p class="scenario-description" id="scenario-description">
            Load a narrated scenario to track major workload shifts, document issues, and AI-powered decisions.
          </p>
        </div>
        <div>
          <label for="scenario-select">Choose scenario</label>
          <select id="scenario-select"></select>
        </div>
      </header>

      <section class="scenario-controls">
        <div class="scenario-actions">
          <button class="play" data-action="play">Play</button>
          <button class="pause" data-action="pause">Pause</button>
          <button class="stop" data-action="stop">Stop</button>
        </div>
        <div class="speed-controls">
          <span>Speed</span>
          <button data-speed="0.5">0.5×</button>
          <button data-speed="1" class="active">1×</button>
          <button data-speed="1.5">1.5×</button>
          <button data-speed="2">2×</button>
        </div>
        <div class="progress-bar">
          <span id="scenario-progress"></span>
        </div>
      </section>

      <section class="timeline-panel">
        <h2>Timeline</h2>
        <div id="timeline-events" class="timeline-list"></div>
      </section>

      <section class="narration-panel">
        <h3>Narration</h3>
        <p id="scenario-narration" class="narration-text">Select a scenario to begin.</p>
      </section>
    </div>
  </main>

  <script src="/js/demo/orchestrator.js"></script>
  <script src="/js/demo/scenario-player.js"></script>
  <script>
    const scenarioCatalog = [
      { id: 'rush-application', label: 'Rush Application' },
      { id: 'complex-review', label: 'Complex Review' },
      { id: 'document-issues', label: 'Document Issues' },
      { id: 'ai-assisted-decision', label: 'AI-Assisted Decision' },
      { id: 'rejection-appeal', label: 'Rejection & Appeal' }
    ];

    const player = new ScenarioPlayer(window.demoOrchestrator);
    const scenarioSelect = document.getElementById('scenario-select');
    const timelineEl = document.getElementById('timeline-events');
    const progressBar = document.getElementById('scenario-progress');
    const narrationEl = document.getElementById('scenario-narration');
    const descriptionEl = document.getElementById('scenario-description');

    function populateScenarios() {
      scenarioCatalog.forEach((scenario) => {
        const option = document.createElement('option');
        option.value = scenario.id;
        option.textContent = scenario.label;
        scenarioSelect.appendChild(option);
      });
    }

    async function handleScenarioChange(event) {
      const id = event.target.value;
      const scenarioDefinition = await player.startScenario(id);
      if (!scenarioDefinition) {
        return;
      }
      descriptionEl.textContent = scenarioDefinition.description || '';
      renderTimeline(scenarioDefinition.steps || []);
      updateNarration('Scenario loaded. Press play to begin.');
    }

    function renderTimeline(steps) {
      timelineEl.innerHTML = '';
      steps.forEach((step, index) => {
        const item = document.createElement('div');
        item.className = 'scenario-step';
        item.dataset.index = index;
        item.innerHTML = `
          <div>
            <strong>${step.title}</strong>
            <span>${step.description}</span>
          </div>
          <span>${(step.duration || 2000) / 1000}s</span>
        `;
        timelineEl.appendChild(item);
      });
    }

    function updateNarration(text) {
      narrationEl.textContent = text;
    }

    function bindControls() {
      document.querySelectorAll('[data-action]').forEach((button) => {
        button.addEventListener('click', () => {
          const action = button.dataset.action;
          if (action === 'play') {
            player.startScenario(scenarioSelect.value);
          } else if (action === 'pause') {
            player.pause();
          } else if (action === 'stop') {
            player.stop();
          }
        });
      });

      document.querySelectorAll('.speed-controls button').forEach((button) => {
        button.addEventListener('click', () => {
          const speed = Number(button.dataset.speed);
          player.setSpeed(speed);
          document.querySelectorAll('.speed-controls button').forEach((btn) => btn.classList.remove('active'));
          button.classList.add('active');
        });
      });

      scenarioSelect.addEventListener('change', handleScenarioChange);
    }

    function highlightStep(index) {
      timelineEl.querySelectorAll('.scenario-step').forEach((element) => {
        element.classList.toggle('active', Number(element.dataset.index) === index);
      });
    }

    function updateProgress() {
      progressBar.style.width = `${player.getProgress() * 100}%`;
      requestAnimationFrame(updateProgress);
    }

    player.on('step-played', ({ step, index }) => {
      updateNarration(step.narration || step.description || step.title);
      highlightStep(index);
    });

    player.on('scenario-complete', () => {
      updateNarration('Scenario complete. Choose another or replay.');
    });

    document.addEventListener('DOMContentLoaded', async () => {
      populateScenarios();
      bindControls();
      updateProgress();
      await handleScenarioChange({ target: { value: scenarioCatalog[0].id } });
    });
  </script>
</body>
</html>
